<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Snakemakeのすゝめ - Sadamori Kojaku</title><meta name=description content="Re-searchをもっと楽に"><meta name=author content="Sadamori Kojaku"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"Sadamori Kojaku","url":"https:\/\/skojaku.github.io\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/skojaku.github.io\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/skojaku.github.io\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/skojaku.github.io\/%E3%83%8E%E3%83%BC%E3%83%88\/snakemake%E3%81%AE%E3%81%99%E3%82%9D%E3%82%81\/","name":"Snakemakeのすゝめ"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Sadamori Kojaku"},"headline":"Snakemakeのすゝめ","description":"研究はトライ＆エラーの連続です。パラメターを変え、データを変え、バグを直し、実験をやり直すことが少なくありません\t🙄。 実験をやり直す時、「このプログラムを直したら、このファイルを入力して、出力されたファイルをあのプログラムに入力して\x26hellip;」といったことに時間を費やしていませんか？ そんな時間をほぼゼロにしてくれるツール、Snakemakeを紹介します。\nSnakemakeとは Snakemakeは、Pythonで書けるmakeコマンドのようなもので、欲しいファイルを指定すれば、それを生成するために必要なプログラムと中間ファイルを自動で特定し、一連の処理を自動で実行してくれるツールです。 後述する並列化やワイルドカードといった強力な機能を持ちながらも、Pythonが持つ簡便さ、柔軟さを合わせ持つのがSnakemakeの強みです💪。\n百聞は一見にしかず、Snakemakeの使い方を例を通して紹介します。 本記事で使ったデータやプログラムをこちらに置いておきますので、ぜひ手元で動かしてみてください。\n準備 まず、Snakemakeをcondaを使ってインストールします。\nconda install -c conda-forge -c bioconda snakemake その他、プログラムの実行に必要なパッケージもインストールします。\nconda install -c conda-forge -c bioconda numpy seaborn matplotlib pandas wikipedia-api ワークフローを作ろう Snakemakeの中心となる考え方がワークフローです。 ワークフローとは、下図のようなファイルを枝とするプログラムとプログラムのネットワークです。\nこのネットワークをSnakefileというファイルに定義していきます。 SnakefileはPythonと同じ構文で書いていきます。SnakemakeはPythonで動くので、関数を定義したりライブラリをインポートしたりなど、基本Pythonで出来ることは一通りできます。\n例として以下のようなワークフローをSnakefileに記述していきましょう。\n Wikipediaから記事のテキスト情報を取得する。 テキスト中の単語を数え上げる。 単語の頻度分布の図を生成する。  はじめに、以下のようなフォルダとSnakefileというテキストファイル（拡張子ナシ）を作ります。\n├── data # ワークフローを実行中に生成された中間ファイルを保管するフォルダ ├── figs # 生成された図を保管するフォルダ ├── Snakefile # Snakefileのファイル └── workflow # workflowで実行するスクリプトを保管するフォルダ まず、Snakefileに、(i) 取得する記事名、(ii) 生成する中間ファイル、そして(iii)最終的な出力ファイルの名前と場所を定義します。\nSnakefile\n1 2 3 4  WIKI_PAGE_TITLE = \x26#34;Sapporo\x26#34; # (i) Wikipediaの記事のタイトル TEXT_DATA = \x26#34;data\/wiki_text.","inLanguage":"en","wordCount":943,"datePublished":"2021-12-19T00:00:00","dateModified":"2021-12-19T00:00:00","image":"","keywords":[""],"mainEntityOfPage":"https:\/\/skojaku.github.io\/%E3%83%8E%E3%83%BC%E3%83%88\/snakemake%E3%81%AE%E3%81%99%E3%82%9D%E3%82%81\/","publisher":{"@type":"Organization","name":"https:\/\/skojaku.github.io\/","logo":{"@type":"ImageObject","url":"","height":60,"width":60}}}</script><meta property="og:title" content="Snakemakeのすゝめ"><meta property="og:description" content="Re-searchをもっと楽に"><meta property="og:image" content><meta property="og:url" content="https://skojaku.github.io/%E3%83%8E%E3%83%BC%E3%83%88/snakemake%E3%81%AE%E3%81%99%E3%82%9D%E3%82%81/"><meta property="og:type" content="website"><meta property="og:site_name" content="Sadamori Kojaku"><meta name=twitter:title content="Snakemakeのすゝめ"><meta name=twitter:description content="Re-searchをもっと楽に"><meta name=twitter:image content><meta name=twitter:card content="summary"><link href=https://skojaku.github.io/favicon.png rel=icon type=image/x-icon><meta name=generator content="Hugo 0.64.0"><link rel=alternate href=https://skojaku.github.io/index.xml type=application/rss+xml title="Sadamori Kojaku"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://skojaku.github.io/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://skojaku.github.io/css/syntax.css><link rel=stylesheet href=https://skojaku.github.io/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://skojaku.github.io/>Sadamori Kojaku</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Research href=/research/>Research</a></li><li><a title=Publications href=/publications/>Publications</a></li><li><a title=ノート href=/%e3%83%8e%e3%83%bc%e3%83%88>ノート</a></li><li><a title=Code href=/code/>Code</a></li><li><a title="About me" href=/about/>About me</a></li></ul></div><div class=avatar-container><div class=avatar-img-border></div></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=ノート-heading style=text-align:center><h1>Snakemakeのすゝめ</h1><h2 class=ノート-subheading style=color:grey;font-weight:400>~<i>Re-searchをもっと楽に</i>~</h2><hr class=small></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><p>研究はトライ＆エラーの連続です。パラメターを変え、データを変え、バグを直し、実験をやり直すことが少なくありません 🙄。
実験をやり直す時、「このプログラムを直したら、このファイルを入力して、出力されたファイルをあのプログラムに入力して&mldr;」といったことに時間を費やしていませんか？
そんな時間をほぼゼロにしてくれるツール、<a href=https://snakemake.readthedocs.io/en/stable/>Snakemake</a>を紹介します。</p><h1 id=snakemakeとは>Snakemakeとは</h1><p>Snakemakeは、Pythonで書ける<code>make</code>コマンドのようなもので、欲しいファイルを指定すれば、それを生成するために必要なプログラムと中間ファイルを自動で特定し、一連の処理を自動で実行してくれるツールです。
後述する並列化やワイルドカードといった強力な機能を持ちながらも、Pythonが持つ簡便さ、柔軟さを合わせ持つのがSnakemakeの強みです💪。</p><p>百聞は一見にしかず、Snakemakeの使い方を例を通して紹介します。
本記事で使ったデータやプログラムを<a href=https://github.com/skojaku/jp-how-to-use-snakemake>こちら</a>に置いておきますので、ぜひ手元で動かしてみてください。</p><h3 id=準備>準備</h3><p>まず、Snakemakeを<a href=https://www.python.jp/install/anaconda/conda.html>conda</a>を使ってインストールします。</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>conda install -c conda-forge -c bioconda snakemake
</code></pre></div><p>その他、プログラムの実行に必要なパッケージもインストールします。</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>conda install -c conda-forge -c bioconda numpy seaborn matplotlib pandas wikipedia-api
</code></pre></div><h1 id=ワークフローを作ろう>ワークフローを作ろう</h1><p>Snakemakeの中心となる考え方が<strong>ワークフロー</strong>です。
ワークフローとは、下図のようなファイルを枝とするプログラムとプログラムのネットワークです。</p><p><img src="https://drive.google.com/uc?export=view&id=1HofLWGPvMQWaoPWrqMafIptF17DvlEJr" alt="intro fig 1"></p><p>このネットワークを<strong>Snakefile</strong>というファイルに定義していきます。
SnakefileはPythonと同じ構文で書いていきます。SnakemakeはPythonで動くので、関数を定義したりライブラリをインポートしたりなど、基本Pythonで出来ることは一通りできます。</p><p>例として以下のようなワークフローをSnakefileに記述していきましょう。</p><ol><li>Wikipediaから記事のテキスト情報を取得する。</li><li>テキスト中の単語を数え上げる。</li><li>単語の頻度分布の図を生成する。</li></ol><p>はじめに、以下のようなフォルダと<em>Snakefile</em>というテキストファイル（拡張子ナシ）を作ります。</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>├── data <span class=c1># ワークフローを実行中に生成された中間ファイルを保管するフォルダ</span>
├── figs <span class=c1># 生成された図を保管するフォルダ</span>
├── Snakefile <span class=c1># Snakefileのファイル</span>
└── workflow <span class=c1># workflowで実行するスクリプトを保管するフォルダ</span>
</code></pre></div><p>まず、Snakefileに、(i) 取得する記事名、(ii) 生成する中間ファイル、そして(iii)最終的な出力ファイルの名前と場所を定義します。</p><p><em>Snakefile</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>WIKI_PAGE_TITLE</span> <span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>Sapporo</span><span class=s2>&#34;</span> <span class=c1># (i) Wikipediaの記事のタイトル</span>
<span class=n>TEXT_DATA</span> <span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>data/wiki_text.txt</span><span class=s2>&#34;</span> <span class=c1># (ii) Wikipediaの記事のテキストを保存するファイル</span>
<span class=n>WORD_COUNT_DATA</span> <span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>data/word_count.csv</span><span class=s2>&#34;</span> <span class=c1># (ii) 単語の頻度を保存するファイル</span>
<span class=n>WORD_COUNT_FIG</span> <span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>figs/word_count.pdf</span><span class=s2>&#34;</span> <span class=c1># (iii) 単語の頻度の分布図を保存するファイル</span>
</code></pre></td></tr></table></div></div><p>次に、<strong>rule</strong>というSnakemake独自の構文を使ってプログラムとファイルの関係を定義していきます。</p><p><em>Snakefile(続き)</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>rule</span> <span class=n>retrieve_wiki_text</span><span class=p>:</span>
    <span class=n>output</span><span class=p>:</span>
        <span class=n>TEXT_DATA</span>
    <span class=n>shell</span><span class=p>:</span>
        <span class=sa></span><span class=s2>&#34;</span><span class=s2>python workflow/get-wikipages.py {WIKI_PAGE_TITLE} {output}</span><span class=s2>&#34;</span>


<span class=n>rule</span> <span class=n>word_count</span><span class=p>:</span>
    <span class=nb>input</span><span class=p>:</span>
        <span class=n>TEXT_DATA</span>
    <span class=n>output</span><span class=p>:</span>
        <span class=n>WORD_COUNT_DATA</span>
    <span class=n>shell</span><span class=p>:</span>
        <span class=sa></span><span class=s2>&#34;</span><span class=s2>python workflow/count-words.py {input} {output}</span><span class=s2>&#34;</span>


<span class=n>rule</span> <span class=n>plot_word_count</span><span class=p>:</span>
    <span class=nb>input</span><span class=p>:</span>
        <span class=n>WORD_COUNT_DATA</span>
    <span class=n>output</span><span class=p>:</span>
        <span class=n>WORD_COUNT_FIG</span>
    <span class=n>shell</span><span class=p>:</span>
        <span class=sa></span><span class=s2>&#34;</span><span class=s2>python workflow/plot-word-frequency.py {input} {output}</span><span class=s2>&#34;</span>

<span class=n>rule</span> <span class=nb>all</span><span class=p>:</span>
    <span class=nb>input</span><span class=p>:</span>
        <span class=n>WORD_COUNT_FIG</span>
</code></pre></td></tr></table></div></div><p>各ルールにぶら下がっている<code>input</code>、<code>output</code>、<code>shell</code>は<strong>directive</strong>（司令文）呼ばれ、
それぞれ入力ファイル、出力ファイル、そしてプログラムの実行コマンドを指定します。例えば、12行目のrule</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>rule</span> <span class=n>word_count</span><span class=p>:</span>
    <span class=nb>input</span><span class=p>:</span>
        <span class=n>TEXT_DATA</span>
    <span class=n>output</span><span class=p>:</span>
        <span class=n>WORD_COUNT_DATA</span>
    <span class=n>shell</span><span class=p>:</span>
        <span class=sa></span><span class=s2>&#34;</span><span class=s2>python workflow/count-words.py {input} {output}</span><span class=s2>&#34;</span>
</code></pre></td></tr></table></div></div><p>では、入力を<em>TEXT_DATA</em>、出力を<em>WORD_COUNT_DATA</em>、そしてプログラムの実行コマンドを&rdquo;<em>python workflow/count-words.py {input} {output}</em>&ldquo;で指定しています。実行コマンド中の&rdquo;<em>{input}</em>&ldquo;と&rdquo;<em>{output}</em>&ldquo;は、コマンド実行時に<em>input</em>と<em>output</em>司令文で指定したファイル名で置換えられます。つまり</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>python workflow/count-words.py data/wiki_text.txt data/word_count.csv
</code></pre></div><p>が最終的に実行されます。 <code>workflow/count-words.py</code>や他のプログラムについては<a href=https://github.com/skojaku/jp-how-to-use-snakemake/tree/main/%E3%83%AF%E3%82%A4%E3%83%AB%E3%83%89%E3%82%AB%E3%83%BC%E3%83%89%E3%81%AE%E3%81%99%E3%82%9D%E3%82%81/workflow>こちら</a>を参照してください。</p><p><em>input</em>、<em>output</em>、 <em>shell</em>は必ず書く必要はありません。例えば、5行名のルールでは入力となるファイルがないのでinput司令文がありません。
司令文には他にも様々な種類があり、そのうちのいくつかは後で紹介します。</p><p>29行目の<code>rule all</code>は特別なルールです。ここには最終的に生成されるファイルを書くのがSnakemakeの流儀です。</p><p>このワークフローを図示するとこんな感じになります。</p><p><img src="https://drive.google.com/uc?export=view&id=1Ilo2zxcryaWFiTc9LU9hZgVsduTS-NOI" alt="intro fig 1"></p><p>Snakemakeは<em>rule all</em>から逆算して必要な中間ファイルとプログラムを見つけ、ワークフローの実行計画を立てていきます。例えば、<em>rule all</em>を実行するためにWORD_COUNT_FIGが必要で、それを生成する<em>plot_word_count</em>を実行するためにはWORD_COUNT_DATAが必要で&mldr;といったようにワークフローを辿っていきます。最終的にSnakemakeが立てた実行計画は以下のコマンドで確認することができます。</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>snakemake -np all
</code></pre></div><p>(<em>実行結果</em>)</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>Building DAG of jobs...
Job stats:
job                   count    min threads    max threads
------------------  -------  -------------  -------------
all                       <span class=m>1</span>              <span class=m>1</span>              <span class=m>1</span>
plot_word_count           <span class=m>1</span>              <span class=m>1</span>              <span class=m>1</span>
retrieve_wiki_text        <span class=m>1</span>              <span class=m>1</span>              <span class=m>1</span>
word_count                <span class=m>1</span>              <span class=m>1</span>              <span class=m>1</span>
total                     <span class=m>4</span>              <span class=m>1</span>              <span class=m>1</span>


<span class=o>[</span>Sat Dec <span class=m>25</span> 21:37:24 2021<span class=o>]</span>
rule retrieve_wiki_text:
    output: data/wiki_text.txt
    jobid: <span class=m>3</span>
    resources: <span class=nv>tmpdir</span><span class=o>=</span>/var/folders/57/9xrg5s891dzfv2s_nfnbj2y40000gq/T
...<span class=o>(</span>続く<span class=o>)</span>
</code></pre></div><p>どのプログラムが何回実行されるのかが表で表示され、続いて各ルールで実行されるコマンドが表示されます。確認が終われば、以下のコマンドでワークフローを実行してみましょう。(補足: &ldquo;snakemake -np all"をしなくてもワークフローを実行できます。)</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>snakemake --cores <span class=m>1</span> all
</code></pre></div><p>この<code>--cores 1</code>は「1 threadを使ってください」という意味で、手持ちのコンピュータの性能に合わせて好きな数に設定できます。</p><p><img src="https://drive.google.com/uc?export=view&id=1dk33ISsjKdV2C1__j7bMg5CQzWKhdamP" alt=demo></p><p>(完成したワークフローは<a href=https://github.com/skojaku/jp-how-to-use-snakemake/tree/main/%E3%83%AF%E3%83%BC%E3%82%AF%E3%83%95%E3%83%AD%E3%83%BC%E3%82%92%E4%BD%9C%E3%82%8D%E3%81%86>こちら</a>)</p><p>最初のプログラムが実行され、終了とともに次のプログラムが順次実行されているのがわかると思います。</p><p>ではもう一度同じコマンドを打つとどうなるでしょうか？
Snakemakeはワークフローの実行計画を立てる際、すでに必要な中間ファイルが存在していれば、そのファイルを生成するルールを<strong>実行しません</strong>。このおかげで、ワークフローを全部実行せずに必要なプログラムだけを実行してくれます。</p><p>では、中間ファイルを改変したらどうなるのでしょうか？中間ファイルを改変すると、それに依存する全ての中間ファイルを作り直さなければなりません。Snakemakeは、<strong>ファイルの変更日時から中間ファイルの改変を検知し、再実行が必要なプログラムを自動判定・再実行してくれます:hand_over_mouth:。</strong></p><h1 id=ワイルドカードのすゝめ>ワイルドカードのすゝめ</h1><p>Snakemakeの目玉機能に<strong>ワイルドカード</strong>があります。ワイルドカードは、何種類もあるデータに対して個別に同じワークフローを走らせたいときにとても便利な機能です。</p><p>具体例として、同じワークフローを"Sapporo"の記事だけでなく、以下の記事に対しても個別に実行してみましょう。</p><p>(<em>Snakefile</em>)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>WIKI_PAGE_TITLE</span> <span class=o>=</span> <span class=p>[</span>
    <span class=sa></span><span class=s2>&#34;</span><span class=s2>Sapporo</span><span class=s2>&#34;</span><span class=p>,</span>
    <span class=sa></span><span class=s2>&#34;</span><span class=s2>Otaru</span><span class=s2>&#34;</span><span class=p>,</span>
    <span class=sa></span><span class=s2>&#34;</span><span class=s2>Hakodate</span><span class=s2>&#34;</span><span class=p>,</span>
    <span class=sa></span><span class=s2>&#34;</span><span class=s2>Asahikawa</span><span class=s2>&#34;</span><span class=p>,</span>
    <span class=sa></span><span class=s2>&#34;</span><span class=s2>Kushiro</span><span class=s2>&#34;</span><span class=p>,</span>
    <span class=sa></span><span class=s2>&#34;</span><span class=s2>Shiretoko_Peninsula</span><span class=s2>&#34;</span>
<span class=p>]</span>
</code></pre></td></tr></table></div></div><p>1つの記事から2つの中間ファイル(TEXT_DATAとWORD_COUNT_DATA)と1つの出力ファイル(WORD_COUNT_FIG)が生成されます。今、6つの記事に対して同じワークフローを走らせるので、3x6=18のファイルをこれから生成します。ファイルの名前と場所をSnakefileに記述しなければなりませんが、これらを１つ１つSnakefileに書いていくのは面倒です。</p><p>そこでワイルドカードの登場です。ワイルドカードを使えば、たった3行で18のファイル名と場所を定義できます。</p><p>(<em>Snakefile</em>)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>TEXT_DATA</span> <span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>data/wiki_text_wikititle={wikititle}.txt</span><span class=s2>&#34;</span>
<span class=n>WORD_COUNT_DATA</span> <span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>data/word_count_wikititle={wikititle}.csv</span><span class=s2>&#34;</span>
<span class=n>WORD_COUNT_FIG</span> <span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>figs/word_count_wikititle={wikititle}.pdf</span><span class=s2>&#34;</span>
</code></pre></td></tr></table></div></div><p>この<code>{}</code>で囲まれた部分がワイルドカードです(wikititleでなくても任意の文字列が使えます)。この<code>{...}</code>の部分は「変数」のようなもので、プログラム実行時にSnakemakeが具体的な文字列を<strong>後で</strong>挿入します。これについては後述しますので、とりあえず「ファイル名の中に変数がある」と理解してください。</p><p>この変数を実行プログラムに渡していきましょう。そのために、<code>rule retrieve_wiki_text</code>を以下のように少し改変します。</p><p>(<em>Snakefile</em>)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>rule</span> <span class=n>retrieve_wiki_text</span><span class=p>:</span>
    <span class=n>output</span><span class=p>:</span>
        <span class=n>TEXT_DATA</span>
    <span class=n>params</span><span class=p>:</span>
        <span class=n>wikititle</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>wildcards</span><span class=p>:</span><span class=n>wildcards</span><span class=o>.</span><span class=n>wikititle</span>
    <span class=n>shell</span><span class=p>:</span>
        <span class=sa></span><span class=s2>&#34;</span><span class=s2>python workflow/get-wikipages.py {params.wikititle} {output}</span><span class=s2>&#34;</span>
</code></pre></td></tr></table></div></div><p><strong>params</strong>という新しい司令文を追加し、<em>shell</em>司令文の中身も少し改変しました。</p><ul><li><em>shell</em>司令文で、<code>{params.wikititle}</code>という変数を参照しています。これは「<em>params</em>という司令文で定義された<em>wikititle</em>という名前の変数」という意味です。このように、<code>{司令文名.変数名}</code>という形で、各司令文の中で定義された変数を参照することができます。</li><li><em>params</em>司令文の役割は、入出力ファイルの中にある変数を取り出すことです。変数はPythonのlambda関数を使って、<code>lambda wildcards: wildcards.&lt;変数名></code>で取り出します</li></ul><p>次に、<code>rule all</code>を以下のように改変します。</p><p>(<em>Snakefile</em>)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>rule</span> <span class=nb>all</span><span class=p>:</span>
    <span class=nb>input</span><span class=p>:</span>
        <span class=n>expand</span><span class=p>(</span><span class=n>WORD_COUNT_FIG</span><span class=p>,</span> <span class=n>wikititle</span><span class=o>=</span><span class=n>WIKI_PAGE_TITLE</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>ここで<code>expand</code>というSnakemake独自の関数が登場します。expandは、ファイル名の変数に具体的な文字列を挿入する関数です。例えば、</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>print</span><span class=p>(</span><span class=n>expand</span><span class=p>(</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>data_{dataname}.txt</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>dataname</span><span class=o>=</span><span class=p>[</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>a</span><span class=s2>&#34;</span><span class=p>,</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>b</span><span class=s2>&#34;</span><span class=p>,</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>c</span><span class=s2>&#34;</span><span class=p>]</span><span class=p>)</span><span class=p>)</span>
<span class=c1># [&#34;data_a.txt&#34;, &#34;data_b.txt&#34;, &#34;data_c.txt&#34;]</span>
</code></pre></div><p>となるように、<code>{dataname}</code>を"a&rdquo;, &ldquo;b&rdquo;, &ldquo;c"のいづれかで置換えます。</p><p>このワークフローを図示すると以下のようになります。</p><p><img src="https://drive.google.com/uc?export=view&id=1MxGpxrv5EhM9ER8hrH-FzsJkOrZB_CYS" alt="intro fig 2"></p><p>(完成したワークフローは<a href=https://github.com/skojaku/jp-how-to-use-snakemake/tree/main/%E3%83%AF%E3%82%A4%E3%83%AB%E3%83%89%E3%82%AB%E3%83%BC%E3%83%89%E3%81%AE%E3%81%99%E3%82%9D%E3%82%81>こちら</a>)</p><p>記事ごとにワークフローが走り、最終的に<code>rule all</code>に統合される形になっています。記事ごとに処理が独立しているので、並列化ができそうですね。実は、Snakemakeには自動で並列実行できる箇所を特定して実行する機能があります:mechanical_arm:。試しに2スレッドで並列実行させてみましょう。</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>snakemake --cores 2 all
</code></pre></div><p><img src="https://drive.google.com/uc?export=view&id=1W-FhstXkJ8WKzbRZjO-2v9cdJYXXoFzR" alt="demo 2"></p><h1 id=ワイルドカードでたくさんのアルゴリズムを試す-テキスト要約を例に>ワイルドカードでたくさんのアルゴリズムを試す: テキスト要約を例に</h1><p>再実験、追実験は計算系の研究では日常です😬。パラメターやアルゴリズムを変えるとどう実験結果が変わるか？という問いは常に起こります。ワイルドカードを使えば、設定を変えた実験を簡単に行うことができます。
この機能について、深層学習に基づく<strong>テキスト要約</strong>を例に解説します。</p><h3 id=準備-1>準備</h3><p>テキスト要約に必要な<a href=https://pytorch.org/get-started/locally/>Pytorch</a>と<a href=https://huggingface.co/docs/transformers/index>transformers</a>をインストールします。Pytorchのインストールは環境ごとに異なるので<a href=https://pytorch.org/get-started/locally/>本サイト</a>の指示に従ってインストールしてください。
私の環境（MAC）では以下のコマンドでPytorchとtransformersをインストールしました。</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># Mac</span>
conda install pytorch torchvision torchaudio -c pytorch <span class=c1># Pytorch</span>
conda install -c huggingface transformers <span class=c1># Transformers</span>
</code></pre></div><h3 id=テキスト要約アルゴリズムとそのパラメター>テキスト要約アルゴリズムとそのパラメター</h3><p>テキスト要約とは、与えられたテキストを指定された文字数内で要約するタスクです。
難しそうなタスクですが、transformersを使って簡単にテキスト要約ができます。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>transformers</span> <span class=kn>import</span> <span class=n>pipeline</span>

<span class=n>model</span> <span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>t5-base</span><span class=s2>&#34;</span> <span class=c1># 深層学習モデルの名前</span>
<span class=n>max_length</span> <span class=o>=</span> <span class=mi>128</span> <span class=c1># 要約テキストの文字数</span>
<span class=n>text</span> <span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>This study finds that ....(続き)</span><span class=s2>&#34;</span> <span class=c1># 入力テキスト</span>

<span class=c1># モデルの準備</span>
<span class=n>summarizer</span> <span class=o>=</span> <span class=n>pipeline</span><span class=p>(</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>summarization</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span> <span class=n>tokenizer</span><span class=o>=</span><span class=n>model</span><span class=p>)</span>

<span class=c1># テキスト要約</span>
<span class=n>summary_text</span> <span class=o>=</span> <span class=n>summarizer</span><span class=p>(</span><span class=n>text</span><span class=p>[</span><span class=p>:</span><span class=mi>1024</span><span class=p>]</span><span class=p>,</span> <span class=n>min_length</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>max_length</span><span class=o>=</span><span class=n>max_length</span><span class=p>)</span><span class=p>[</span>
    <span class=sa></span><span class=s2>&#34;</span><span class=s2>summary_text</span><span class=s2>&#34;</span>
<span class=p>]</span>
</code></pre></td></tr></table></div></div><p>変数<code>model</code>と<code>max_length</code>はそれぞれモデルの名前と要約テキストの文字数です。この2つを変えると要約も変わります。</p><h3 id=ワイルドカードを使ってモデルとパラメターを指定する>ワイルドカードを使ってモデルとパラメターを指定する</h3><p>要約したテキストを保存するファイル名を定義します。
要約は(i)元となる記事、(ii)モデル、(iii)モデルのパラメターの3要素に依存するので、これらを変数とするファイル名をワイルドカードを使って定義します。</p><p>(<em>Snakefile</em>)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>SUMMARIZED_TEXT</span> <span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>data/summary_wikititle={wikititle}_model={model}_len={max_length}.csv</span><span class=s2>&#34;</span>
</code></pre></td></tr></table></div></div><p>次に、それぞれの変数に代入する値をリストします。テキスト要約に使えるモデル名については<a href="https://huggingface.co/models?pipeline_tag=summarization&sort=downloads">Huggingfaceのページ</a>を参照してください。 ここでは"t5-base"と、それを簡略化した"t5-small"を使います。</p><p>(<em>Snakefile</em>続き)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>MODEL_LIST</span> <span class=o>=</span> <span class=p>[</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>t5-base</span><span class=s2>&#34;</span><span class=p>,</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>t5-small</span><span class=s2>&#34;</span><span class=p>]</span>
<span class=n>MAX_LENGTH</span> <span class=o>=</span> <span class=p>[</span><span class=mi>32</span><span class=p>,</span> <span class=mi>128</span><span class=p>]</span>  <span class=c1># Length of the summarized text</span>
<span class=n>WIKI_PAGE_TITLE</span> <span class=o>=</span> <span class=p>[</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>Sapporo</span><span class=s2>&#34;</span><span class=p>,</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>Otaru</span><span class=s2>&#34;</span><span class=p>]</span> <span class=c1># Wiki page titles</span>
</code></pre></td></tr></table></div></div><p>テキスト要約のためのルールを記述します。</p><p>(<em>Snakefile</em>続き)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>rule</span> <span class=n>summary</span><span class=p>:</span>
    <span class=nb>input</span><span class=p>:</span>
        <span class=n>TEXT_DATA</span><span class=p>,</span>
    <span class=n>output</span><span class=p>:</span>
        <span class=n>SUMMARIZED_TEXT</span><span class=p>,</span>
    <span class=n>params</span><span class=p>:</span>
        <span class=n>max_length</span><span class=o>=</span><span class=k>lambda</span> <span class=n>wildcards</span><span class=p>:</span> <span class=n>wildcards</span><span class=o>.</span><span class=n>max_length</span><span class=p>,</span>
        <span class=n>model</span><span class=o>=</span><span class=k>lambda</span> <span class=n>wildcards</span><span class=p>:</span> <span class=n>wildcards</span><span class=o>.</span><span class=n>model</span><span class=p>,</span>
    <span class=n>shell</span><span class=p>:</span>
        <span class=sa></span><span class=s2>&#34;</span><span class=s2>python workflow/summarize.py {input} {params.model} {params.max_length} {output}</span><span class=s2>&#34;</span>
</code></pre></td></tr></table></div></div><p>(<em>summarize.py</em>)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=sa></span><span class=s2>&#34;&#34;&#34;</span><span class=s2>Program to extract text from the given Wikipedia page titles</span><span class=s2>&#34;&#34;&#34;</span>
<span class=kn>import</span> <span class=nn>sys</span>
<span class=kn>from</span> <span class=nn>transformers</span> <span class=kn>import</span> <span class=n>pipeline</span>

<span class=n>input_file</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
<span class=n>model</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
<span class=n>max_length</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span>
<span class=n>output_file</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span>

<span class=c1>#</span>
<span class=c1># Read the input file</span>
<span class=c1>#</span>
<span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>input_file</span><span class=p>,</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>r</span><span class=s2>&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
    <span class=n>text</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=p>)</span>

<span class=c1>#</span>
<span class=c1># Load model</span>
<span class=c1>#</span>
<span class=n>summarizer</span> <span class=o>=</span> <span class=n>pipeline</span><span class=p>(</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>summarization</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span> <span class=n>tokenizer</span><span class=o>=</span><span class=n>model</span><span class=p>)</span>

<span class=c1>#</span>
<span class=c1># Summarize</span>
<span class=c1>#</span>
<span class=n>summary_text</span> <span class=o>=</span> <span class=n>summarizer</span><span class=p>(</span><span class=n>text</span><span class=p>[</span><span class=p>:</span><span class=mi>1024</span><span class=p>]</span><span class=p>,</span> <span class=n>min_length</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>max_length</span><span class=o>=</span><span class=n>max_length</span><span class=p>)</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=p>[</span>
    <span class=sa></span><span class=s2>&#34;</span><span class=s2>summary_text</span><span class=s2>&#34;</span>
<span class=p>]</span>

<span class=c1>#</span>
<span class=c1># Save</span>
<span class=c1>#</span>
<span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>output_file</span><span class=p>,</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>w</span><span class=s2>&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
    <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>summary_text</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p><em>params</em>司令文で<code>model</code>と<code>max_length</code>を取り出し、<em>shell</em>司令文でプログラムに渡しています。こうすることで要約に使うモデルとそのパラメターを指定しています。</p><p>最後に、<code>rule all</code>に生成したいファイルを<em>input</em>司令文に書きます。</p><p>(<em>Snakefile</em>)</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>rule</span> <span class=nb>all</span><span class=p>:</span>
    <span class=nb>input</span><span class=p>:</span>
        <span class=n>expand</span><span class=p>(</span>
            <span class=n>WORD_COUNT_FIG</span><span class=p>,</span>
            <span class=n>wikititle</span><span class=o>=</span><span class=n>WIKI_PAGE_TITLE</span><span class=p>,</span>
            <span class=n>model</span><span class=o>=</span><span class=n>MODEL_LIST</span><span class=p>,</span>
            <span class=n>MAX_LENGTH</span><span class=o>=</span><span class=n>MAX_LENGTH_LIST</span><span class=p>,</span>
        <span class=p>)</span><span class=p>,</span>
</code></pre></div><p>ちなみに、expandに複数のリストを渡すと、その要素の全組み合わせを返してくれます。例えば、</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>expand</span><span class=p>(</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>data_{dataname}_{t}.csv</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>dataname</span> <span class=o>=</span> <span class=p>[</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>a</span><span class=s2>&#34;</span><span class=p>,</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>b</span><span class=s2>&#34;</span><span class=p>,</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>c</span><span class=s2>&#34;</span><span class=p>]</span><span class=p>,</span> <span class=n>t</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>]</span><span class=p>)</span>
</code></pre></div><p>とすると、3x2=6通りの文字列<code>data_a_1.csv</code>, <code>data_a_2.csv</code>, <code>data_b_1.csv</code>, <code>data_b_2.csv</code>, <code>data_c_1.csv</code>, <code>data_c_2.csv</code>が生成されます。</p><p>では実際に動かして見ましょう。</p><p><img src="https://drive.google.com/uc?export=view&id=1wmAUHK5JQmkrKDu4nEolKGUHsi86P3o_" alt="demo 3"></p><p>(完成したワークフローは<a href=https://github.com/skojaku/jp-how-to-use-snakemake/tree/main/%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E8%A6%81%E7%B4%84>こちら</a>)</p><p>同じモデル、異なるパラメタ（max_length=32と128）で生成された要約はこのようになりました。</p><ul><li><strong>(data/summary_wikititle=Otaru_model=t5-base_len=128.csv)</strong>
Otaru shi is a city and port in Shiribeshi Subprefecture Hokkaido Japan northwest of Sapporo . it faces Ishikari Bay and the Sea of Japan and has long served as the main port of the bay . the city has an estimated population of 115 333 and a population density of 474.37 persons per km2.</li><li><strong>(data/summary_wikititle=Otaru_model=t5-base_len=32.csv)</strong>
Otaru shi is a city and port in Shiribeshi Subprefecture Hokkaido Japan northwest of Sapporo.</li></ul><p>大きな<code>max_length</code>を設定した場合に要約が長くなっています。次にモデルを変えた場合を見て見ましょう。</p><ul><li><strong>(data/summary_wikititle=Otaru_model=t5-small_len=128.csv)</strong>
the city faces Ishikari Bay and the Sea of Japan and has long served as the main port of the bay . as of July 31 2019 the city has an estimated population of 115 333 and a population density of 474.37 persons per km2 1 228.6 persons per sq. mi .</li><li><strong>(data/summary_wikititle=Otaru_model=t5-small_len=32.csv)</strong>
the city faces Ishikari Bay and the Sea of Japan and has long served as the main port of the bay . the city has an estimated</li></ul><p>モデルを変えたので全く異なる要約になっています。</p><p>３種類の変数(<code>wikititle</code>, <code>model</code>, <code>max_length</code>)それぞれは2つの値を取るので、計2x2x2=8通りの要約が生成されました。このようにワイルドカードを使えば、簡単に色々なデータやアルゴリム、パラメターの組み合わせを試すことができます。</p><h1 id=snakefileを簡単に書く>Snakefileを簡単に書く</h1><p>ワイルドカードが増えたりすると、いちいち<em>params</em>司令文で変数を取り出して<em>shell</em>でプログラムに渡すのが大変になってきます。例えば、変数が10個もあったとすると、</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>rule</span> <span class=n>too_many_variables</span><span class=p>:</span>
    <span class=nb>input</span><span class=p>:</span>
        <span class=n>INPUT_FILE</span>
    <span class=n>output</span><span class=p>:</span>
        <span class=n>OUTPUT_FILE</span>
    <span class=n>params</span><span class=p>:</span>
        <span class=n>var1</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>wildcards</span><span class=p>:</span> <span class=n>wildcards</span><span class=o>.</span><span class=n>var1</span><span class=p>,</span>
        <span class=n>var2</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>wildcards</span><span class=p>:</span> <span class=n>wildcards</span><span class=o>.</span><span class=n>var2</span><span class=p>,</span>
        <span class=o>.</span><span class=o>.</span><span class=o>.</span>
        <span class=n>var10</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>wildcards</span><span class=p>:</span> <span class=n>wildcards</span><span class=o>.</span><span class=n>var10</span><span class=p>,</span>
    <span class=n>shell</span><span class=p>:</span>
        <span class=sa></span><span class=s2>&#34;</span><span class=s2>python workflow/test.py {input} {params.var1} {params.var2} ... {params.var10} {output}</span><span class=s2>&#34;</span>
</code></pre></div><p>となり、<em>shell</em>司令文で変数をプログラムに渡すときに、正しい順序で変数を渡さなければなりません。後でプログラムを改変するときにバグの原因になりかねません。</p><p>そこで便利なのが、<code>script</code>司令文。この司令文を使うと変数の順序を気にすることなくプログラムに変数を渡すことができます。具体的に、さきほどのruleを<code>script</code>司令文を使って書き直すと、</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>rule too_many_variables:
    input:
        input_file = INPUT_FILE
    output:
        output_file = OUTPUT_FILE
    params:
        var1 = lambda wildcards: wildcards.var1,
        var2 = lambda wildcards: wildcards.var2,
        ...
        var10 = lambda wildcards: wildcards.var10,
    script:
        &#34;workflow/test.py&#34;
</code></pre></div><p>となります。変更点は</p><ul><li><em>shell</em>司令文の代わりに<em>script</em>司令文を使う</li><li><em>script</em>司令文では<code>python workflow/test.py ...</code>といった実行コマンドではなく、Pythonスクリプト<code>workflow/test.py</code>を指定</li><li><em>input</em>司令文で指定した入力ファイル名(INPUT_FILE)を変数<em>input_file</em>に代入した（変数名はなんでも良い）。<em>output</em>司令文でも同様。</li></ul><p><em>script</em>司令文の利点は、 入出力ファイル名やparamsで取り出した変数を、実行スクリプト(test.py)から直接参照できる点です。SnakemakeがPythonスクリプトを実行する際、<code>snakemake</code>というPythonの"dict"っぽいものを作ります。その中には入出力ファイル名やparamsで取り出した変数が入っており、<code>snakemake.&lt;司令文名>[&lt;変数名>]</code>でアクセスできます。
例えば、</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>input_file</span> <span class=o>=</span> <span class=n>snakemake</span><span class=o>.</span><span class=n>input</span><span class=p>[</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>input_file</span><span class=s2>&#34;</span><span class=p>]</span>
</code></pre></div><p>とすると、<em>input</em>司令文で<em>input_file</em>に代入した入力ファイル名が実行されるスクリプトから直接参照できます。 これを利用すれば</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>input_file</span> <span class=o>=</span> <span class=n>snakemake</span><span class=o>.</span><span class=n>input</span><span class=p>[</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>input_file</span><span class=s2>&#34;</span><span class=p>]</span>
<span class=n>output_file</span> <span class=o>=</span> <span class=n>snakemake</span><span class=o>.</span><span class=n>output</span><span class=p>[</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>output_file</span><span class=s2>&#34;</span><span class=p>]</span>
<span class=n>var2</span> <span class=o>=</span> <span class=n>snakemake</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>var2</span><span class=s2>&#34;</span><span class=p>]</span>
<span class=n>var1</span> <span class=o>=</span> <span class=n>snakemake</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>var1</span><span class=s2>&#34;</span><span class=p>]</span>
<span class=n>var9</span> <span class=o>=</span> <span class=n>snakemake</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>var9</span><span class=s2>&#34;</span><span class=p>]</span>
<span class=o>.</span><span class=o>.</span><span class=o>.</span>
</code></pre></div><p>のように、<strong>変数の順序を考えなくても、スクリプトに変数を渡すことができます</strong>😉。</p><p>この機能には一つデメリットがあります。<code>snakemake</code>はSnakemakeが作る独自の変数なので、Snakemakeを介さずに"python workflow/test.py"と直接実行すると「<code>snakemake</code>が定義されていません」というエラーが出ます。これはプログラムの動作確認をするときに厄介なので、私流ですが、ワークフローに加えるスクリプトの先頭には必ず以下のようなコードを置いています。</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>sys</span>

<span class=k>if</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>snakemake</span><span class=s2>&#34;</span> <span class=ow>in</span> <span class=n>sys</span><span class=o>.</span><span class=n>modules</span><span class=p>:</span>
    <span class=n>input_file</span> <span class=o>=</span> <span class=n>snakemake</span><span class=o>.</span><span class=n>input</span><span class=p>[</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>input_file</span><span class=s2>&#34;</span><span class=p>]</span>
    <span class=n>output_file</span> <span class=o>=</span> <span class=n>snakemake</span><span class=o>.</span><span class=n>output</span><span class=p>[</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>output_file</span><span class=s2>&#34;</span><span class=p>]</span>
    <span class=n>mdoel</span> <span class=o>=</span> <span class=n>snakemake</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>model</span><span class=s2>&#34;</span><span class=p>]</span>
    <span class=n>max_length</span> <span class=o>=</span> <span class=n>snakemake</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>max_length</span><span class=s2>&#34;</span><span class=p>]</span>
<span class=k>else</span><span class=p>:</span>
    <span class=n>input_file</span> <span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>data/wiki_text_wikititle=Sapporo.txt</span><span class=s2>&#34;</span>
    <span class=n>output_file</span> <span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>data/summary_wikititle=Sapporo_model=t5-small_len=128.csv</span><span class=s2>&#34;</span>
    <span class=n>model</span> <span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>t5-base</span><span class=s2>&#34;</span>
    <span class=n>max_length</span> <span class=o>=</span> <span class=mi>32</span>
</code></pre></div><p>こうしておけば、Snakemakeを介さずに直接実行できますし、Snakemakeから実行したときには<code>snakemake</code>から変数を受け取ることができます。また、パラメターの具体例が書いてあるので、プログラムの使い方の健忘録にもなります。</p><p>応用編のコードを<code>script</code>を使って書き換えたものを<a href=https://github.com/skojaku/jp-how-to-use-snakemake/tree/main/%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E8%A6%81%E7%B4%84(script%E5%8F%B8%E4%BB%A4%E6%96%87%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E5%A0%B4%E5%90%88)>こちら</a>に置きます。</p><h1 id=おわりに>おわりに</h1><p>ワークフローの組み立て・実行ツール、Snakemakeを紹介しました。
ワークフローを組むことで研究の再現性が上がり、バグの修正も簡単に行えるようになります。また、たくさんのデータやアルゴリズムを試していく探索的な研究がかなり簡単に行えるようになります。</p><p>Snakemakeにはたくさんの機能があり、Snakemakeのページを訪れる度に新しい機能が追加されているほど、今でも活発に開発が行われています。
そんなSnakemakeを習得するには少なくないトライ＆エラーが必要になります。
しかし、その時間ロスを差し引いても、将来的に実験の時間コストを大幅に抑えられると思います。</p><p>「研究」は英語で"Re-search&rdquo;(再探索)と書くように、新しい実験よりも、再実験、追実験が日常です。Snakemakeは再探索の繰り返しから研究者を解放し、新しい実験に集中させてくれます。Snakemakeを使って新しいことに時間を使ってみませんか😉？</p></article><ul class="pager blog-pager"></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=mailto:skojaku@iu.edu title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted">Sadamori Kojaku
&nbsp;&bull;&nbsp;&copy;
2021
&nbsp;&bull;&nbsp;
<a href=https://skojaku.github.io/>Sadamori Kojaku</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.64.0</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=https://skojaku.github.io/js/main.js></script><script>renderMathInElement(document.body);</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://skojaku.github.io/js/load-photoswipe.js></script></body></html>